/* alv-ch-ng.security - 0.2.1 - 2015-06-09 - Copyright (c) 2015 Informatik der Arbeitslosenversicherung; */
!function(){"use strict";var module=angular.module("alv-ch-ng.security",["ngResource","ui.router","LocalStorageModule","pascalprecht.translate","ab-base64"]);module.config(function($stateProvider){$stateProvider.state("login",{parent:"site",url:"/login",views:{"content@":{templateUrl:"template/security/login.html",controller:"LoginCtrl"}},hidden:!0}),$stateProvider.state("accessdenied",{parent:"site",url:"/accessdenied",views:{"content@":{templateUrl:"template/security/accessdenied.html"}},hidden:!0})}),module.run(function($rootScope,Principal,$state,$http,$window,SecurityService,localStorageService){function authenticate(userData){Principal.authenticate({userName:userData.user_name,roles:userData.authorities,jti:userData.jti})}function handleSB64UserData(data){data&&authenticate(JSON.parse(decodeURIComponent($window.atob(data))))}function redirectTo(redirectTarget,event){event.preventDefault(),$state.go(redirectTarget)}function checkAuthorization(event){Principal.isIdentityResolved()&&!Principal.isInAnyRole($rootScope.toState.data.roles)&&redirectTo(STATE_ACCESS_DENIED,event)}function checkAccess(event){$rootScope.toState.data.authenticated&&!Principal.isIdentityResolved()?redirectTo(STATE_LOGIN,event):$rootScope.toState.data.roles&&$rootScope.toState.data.roles.length>0&&checkAuthorization(event)}var STATE_LOGIN="login",STATE_ACCESS_DENIED="accessdenied",token=localStorageService.get("auth_token");token&&token.expires_at&&new Date(token.expires_at).getTime()>(new Date).getTime()&&($http.defaults.headers.common.Authorization="Bearer "+token.access_token,handleSB64UserData(token.access_token.split(".")[1])),$rootScope.$on("$stateChangeStart",function(event,toState,toStateParams){$rootScope.toState=toState,$rootScope.toStateParams=toStateParams,$rootScope.toState.data&&checkAccess(event)})})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.directive("anonymous",function(Principal){return{restrict:"A",link:function(scope,element){scope.$watch(Principal.isAuthenticated,function(newValue){newValue?element.hide():element.show()})}}})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.directive("anyRole",function(Principal){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(function(){return Principal.isInAnyRole(attrs.anyRole)},function(newValue){newValue?element.show():element.hide()})}}})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.factory("authInterceptor",["$rootScope","$q","$location","localStorageService",function($rootScope,$q,$location,localStorageService){function addTokenIfNotExpired(token,config){token&&token.expires_at&&new Date(token.expires_at).getTime()>(new Date).getTime()&&(config.headers.Authorization="Bearer "+token.access_token)}return{request:function(config){return config.headers=config.headers||{},addTokenIfNotExpired(localStorageService.get("token"),config),config}}}])}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.factory("AuthServerProvider",["$http","localStorageService","SecurityConfig","base64",function($http,localStorageService,SecurityConfig,base64){function createLoginData(credentials){return"oauth2"===SecurityConfig.getAuthType()?"username="+credentials.username+"&password="+credentials.password+"&grant_type=password&scope=read%20write&client_secret="+SecurityConfig.getClientSecret()+"&client_id="+SecurityConfig.getClientId()+"&response_type=code":"j_username="+encodeURIComponent(credentials.username)+"&j_password="+encodeURIComponent(credentials.password)+"&submit=Login"}function createLoginHeaders(){return"oauth2"===SecurityConfig.getAuthType()?{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json",Authorization:"Basic "+base64.encode(SecurityConfig.getClientId()+":"+SecurityConfig.getClientSecret())}:{"Content-Type":"application/x-www-form-urlencoded"}}function createLoginRequest(data,headers){return $http.post(SecurityConfig.getAuthPath(),data,{headers:headers,ignoreAuthModule:"ignoreAuthModule"}).success(function(response){if("oauth2"===SecurityConfig.getAuthType()){var expiredAt=new Date;expiredAt.setSeconds(expiredAt.getSeconds()+response.expires_in),response.expires_at=expiredAt.getTime(),localStorageService.set("auth_token",response)}})}function login(credentials){if("oauth2"!==SecurityConfig.getAuthType()&&"cookie"!==SecurityConfig.getAuthType())throw new Error('No or unknown authType found: "'+SecurityConfig.getAuthType()+'".');return createLoginRequest(createLoginData(credentials),createLoginHeaders())}function getToken(){return localStorageService.get("auth_token")}function hasValidToken(){var token=getToken();return token&&token.expires_at&&token.expires_at>(new Date).getTime()}return{login:login,getToken:getToken,hasValidToken:hasValidToken}}])}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.directive("authenticated",function(Principal){return{restrict:"A",link:function(scope,element){element.hide(),scope.$watch(Principal.isAuthenticated,function(){Principal.authenticated?element.show():element.hide()})}}})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.controller("LoginCtrl",["$scope","$timeout","SecurityService",function($scope,$timeout,SecurityService){$scope.userName="",$scope.password="",$scope.rememberMe=!0,$scope.errors={},$timeout(function(){angular.element('[ng-model="username"]').focus()}),$scope.login=function(){SecurityService.login({username:$scope.username,password:$scope.password,rememberMe:$scope.rememberMe})}}])}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.factory("Principal",function(){function checkRoles(roles){for(var results=[],i=0;i<roles.length;i++)results.push(service.isInRole(roles[i]));return results}function splitIfString(roles){return angular.isString(roles)?roles.split(","):roles}var _identity=null,service={authenticated:!1,isIdentityResolved:function(){return _identity?!0:!1},isAuthenticated:function(){return service.authenticated},isInRole:function(role){return role?service.authenticated&&_identity.roles?-1!==_identity.roles.indexOf(role.trim()):!1:!0},isInAnyRole:function(roles){return roles&&0!==roles.length?checkRoles(splitIfString(roles)).indexOf(!0)>-1:!0},authenticate:function(identity){_identity=identity,service.authenticated=null!==identity},getIdentity:function(){return _identity}};return service})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.provider("SecurityConfig",function(){var _clientId="",_clientSecret="",_authPath="/uaa/oauth/token",_logoutPath="uaa/oauth/revoke",_registerPath="api/register",_activationPath="api/activate",_accountPath="api/account",_resendPasswordPath="api/account/resendPassword",_newPasswordPath="api/account/newPassword",_userIdParam="key",_authType="oauth2";this.setClientId=function(clientId){_clientId=clientId},this.setClientSecret=function(clientSecret){_clientSecret=clientSecret},this.setAuthPath=function(authPath){_authPath=authPath},this.setLogoutPath=function(logoutPath){_logoutPath=logoutPath},this.setRegisterPath=function(registerPath){_registerPath=registerPath},this.setActivationPath=function(activationPath){_activationPath=activationPath},this.setAccountPath=function(accountPath){_accountPath=accountPath},this.setResendPasswordPath=function(resendPasswordPath){_resendPasswordPath=resendPasswordPath},this.setNewPasswordPath=function(newPasswordPath){_newPasswordPath=newPasswordPath},this.setUserIdParam=function(userIdParam){_userIdParam=userIdParam},this.setAuthType=function(authType){_authType=authType},this.$get=function(){return{getClientId:function(){return _clientId},getClientSecret:function(){return _clientSecret},getAuthPath:function(){return _authPath},getLogoutPath:function(){return _logoutPath},getRegisterPath:function(){return _registerPath},getActivationPath:function(){return _activationPath},getAccountPath:function(){return _accountPath},getResendPasswordPath:function(){return _resendPasswordPath},getNewPasswordPath:function(){return _newPasswordPath},getUserIdParam:function(){return _userIdParam},getAuthType:function(){return _authType}}}})}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.controller("SecurityCtrl",["$scope","SecurityService",function($scope,SecurityService){$scope.credentials={username:"",password:"",rememberMe:!1},$scope.login=function(){SecurityService.login($scope.credentials)},$scope.logout=function(){SecurityService.logout(),$scope.credentials={username:"",password:"",rememberMe:!1}}}])}(),function(){"use strict";var module=angular.module("alv-ch-ng.security");module.factory("SecurityService",["$rootScope","$http","$q","Principal","AuthServerProvider","SecurityConfig","$window","localStorageService",function($rootScope,$http,$q,Principal,AuthServerProvider,SecurityConfig,$window,localStorageService){function login(credentials){AuthServerProvider.login(credentials).success(function(data){var userData=decodeURIComponent($window.atob(data.access_token.split(".")[1])),account={userName:userData.user_name,roles:userData.authorities,jti:userData.jti};Principal.authenticate(account),angular.isFunction(_onLoginSuccess)&&_onLoginSuccess(account)}).error(function(error){angular.isFunction(_onLoginFail)&&_onLoginFail(error)})}function logout(){Principal.authenticate(null),localStorageService.clearAll()}function register(account){return $http.post(SecurityConfig.getRegisterPath(),account)}function activateAccount(data){return $http.post(SecurityConfig.getActivationPath(),data)}function updateAccount(account){return $http.post(SecurityConfig.getAccountPath()+"/"+account[SecurityConfig.getUserIdParam()],account)}function getAccount(key){return $http.get(SecurityConfig.getAccountPath()+"/"+key)}function changePassword(newPassword){return $http.post(SecurityConfig.getNewPasswordPath(),{newPassword:newPassword})}function resendPassword(userName){return $http.post(SecurityConfig.getResendPasswordPath(),{userName:userName})}var _onLoginFail=function(){$rootScope.loginError=!0},_onLoginSuccess=function(identity){Principal.authenticate(identity),$rootScope.back()};return{login:login,logout:logout,updateAccount:updateAccount,activateAccount:activateAccount,getAccount:getAccount,register:register,changePassword:changePassword,resendPassword:resendPassword,setOnLoginSuccess:function(onLoginSuccess){_onLoginSuccess=onLoginSuccess},setOnLoginFail:function(onLoginFail){_onLoginFail=onLoginFail}}}])}(),angular.module("alv-ch-ng.security").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("template/security/accessdenied.html",'<div ng-cloak>\n    <div class="row">\n        <div class="col-md-12">\n            <h1 translate="errors.title">Error Page!</h1>\n\n            <div class="alert alert-danger" translate="errors.403"></div>\n        </div>\n    </div>\n</div>'),$templateCache.put("template/security/login.html",'<div>\n    <div class="row">\n        <div class="col-md-4 col-md-offset-4">\n            <h1 translate="login.title">Authentication</h1>\n\n            <div class="alert alert-danger" ng-show="authenticationError"\n                 translate="login.messages.error.authentication">\n                <strong>Authentication failed!</strong> Please check your credentials and try again.\n            </div>\n            <form class="form" role="form">\n                <div class="form-group">\n                    <label for="username" translate="global.form.username">Login</label>\n                    <input type="text" class="form-control" id="username"\n                           placeholder="{{\'global.form.username.placeholder\' | translate}}" ng-model="username" />\n                </div>\n                <div class="form-group">\n                    <label for="password" translate="login.form.password">Password</label>\n                    <input type="password" class="form-control" id="password"\n                           placeholder="{{\'login.form.password.placeholder\' | translate}}" ng-model="password" />\n                </div>\n                <button type="submit" class="btn btn-primary" ng-click="login()" translate="login.form.button">\n                    Authenticate\n                </button>\n            </form>\n        </div>\n    </div>\n</div>\n')}]),angular.module("ab-base64",[]).constant("base64",function(){var B64={alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",lookup:null,ie:/MSIE /.test(navigator.userAgent),ieo:/MSIE [67]/.test(navigator.userAgent),encode:function(s){var result,nan0,nan1,nan2,buffer=B64.toUtf8(s),position=-1,len=buffer.length,enc=[,,,];if(B64.ie){for(result=[];++position<len;)nan0=buffer[position],nan1=buffer[++position],enc[0]=nan0>>2,enc[1]=(3&nan0)<<4|nan1>>4,isNaN(nan1)?enc[2]=enc[3]=64:(nan2=buffer[++position],enc[2]=(15&nan1)<<2|nan2>>6,enc[3]=isNaN(nan2)?64:63&nan2),result.push(B64.alphabet.charAt(enc[0]),B64.alphabet.charAt(enc[1]),B64.alphabet.charAt(enc[2]),B64.alphabet.charAt(enc[3]));return result.join("")}for(result="";++position<len;)nan0=buffer[position],nan1=buffer[++position],enc[0]=nan0>>2,enc[1]=(3&nan0)<<4|nan1>>4,isNaN(nan1)?enc[2]=enc[3]=64:(nan2=buffer[++position],enc[2]=(15&nan1)<<2|nan2>>6,enc[3]=isNaN(nan2)?64:63&nan2),result+=B64.alphabet[enc[0]]+B64.alphabet[enc[1]]+B64.alphabet[enc[2]]+B64.alphabet[enc[3]];return result},decode:function(s){if(s=s.replace(/\s/g,""),s.length%4)throw new Error("InvalidLengthError: decode failed: The string to be decoded is not the correct length for a base64 encoded string.");if(/[^A-Za-z0-9+\/=\s]/g.test(s))throw new Error("InvalidCharacterError: decode failed: The string contains characters invalid in a base64 encoded string.");var result,buffer=B64.fromUtf8(s),position=0,len=buffer.length;if(B64.ieo){for(result=[];len>position;)buffer[position]<128?result.push(String.fromCharCode(buffer[position++])):buffer[position]>191&&buffer[position]<224?result.push(String.fromCharCode((31&buffer[position++])<<6|63&buffer[position++])):result.push(String.fromCharCode((15&buffer[position++])<<12|(63&buffer[position++])<<6|63&buffer[position++]));return result.join("")}for(result="";len>position;)result+=buffer[position]<128?String.fromCharCode(buffer[position++]):buffer[position]>191&&buffer[position]<224?String.fromCharCode((31&buffer[position++])<<6|63&buffer[position++]):String.fromCharCode((15&buffer[position++])<<12|(63&buffer[position++])<<6|63&buffer[position++]);return result},toUtf8:function(s){var chr,position=-1,len=s.length,buffer=[];if(/^[\x00-\x7f]*$/.test(s))for(;++position<len;)buffer.push(s.charCodeAt(position));else for(;++position<len;)chr=s.charCodeAt(position),128>chr?buffer.push(chr):2048>chr?buffer.push(chr>>6|192,63&chr|128):buffer.push(chr>>12|224,chr>>6&63|128,63&chr|128);return buffer},fromUtf8:function(s){var len,position=-1,buffer=[],enc=[,,,];if(!B64.lookup){for(len=B64.alphabet.length,B64.lookup={};++position<len;)B64.lookup[B64.alphabet.charAt(position)]=position;position=-1}for(len=s.length;++position<len&&(enc[0]=B64.lookup[s.charAt(position)],enc[1]=B64.lookup[s.charAt(++position)],buffer.push(enc[0]<<2|enc[1]>>4),enc[2]=B64.lookup[s.charAt(++position)],64!==enc[2])&&(buffer.push((15&enc[1])<<4|enc[2]>>2),enc[3]=B64.lookup[s.charAt(++position)],64!==enc[3]);)buffer.push((3&enc[2])<<6|enc[3]);return buffer}},B64url={decode:function(input){input=input.replace(/-/g,"+").replace(/_/g,"/");var pad=input.length%4;if(pad){if(1===pad)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");input+=new Array(5-pad).join("=")}return B64.decode(input)},encode:function(input){var output=B64.encode(input);return output.replace(/\+/g,"-").replace(/\//g,"_").split("=",1)[0]}};return{decode:B64.decode,encode:B64.encode,urldecode:B64url.decode,urlencode:B64url.encode}}());